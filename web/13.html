<html>
<head>
	<meta charset="utf-8">
	<!-- ①ライブラリの読み込み -->
	<script src="https://unpkg.com/deck.gl@^8.9/dist.min.js"></script>
	<script src="https://unpkg.com/@loaders.gl/3d-tiles@^3.4/dist/dist.min.js"></script>
	<!-- ③地図領域のスタイル定義（100%全体） -->
	<!-- ⑭（1）高さ500pxに変更 -->
	<style>
		#container { position: relative; inset: 0; height: 500px;}
		#container > * {
			inset: 0; width: 100%; height: 100%; }
	</style>
	<script type="module">
		// ⑥光を当てる
		// （a）環境光
		const ambientLight = new deck.AmbientLight({
		  color: [255, 255, 255],
		  intensity: 3.0
		});
		// （b）太陽光
		const directionalLight = new deck._SunLight({
		  timestamp: Date.UTC(2024, 7, 1, 11),
		  color: [255, 255, 255],
		  intensity: 3.0,
		});	
		// （c）LightingEffectの作成
		const lightingEffect = new deck.LightingEffect({ambientLight, directionalLight});
		
		// ⑦地理院地図のレイヤー
		const tileLayer = new deck.TileLayer({
			  data: "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
			  minZoom: 5,
			  maxZoom: 18,
			  tileSize: 256,
			  renderSubLayers: props => new deck.BitmapLayer(props, {
			    data: null,
			    image: props.data,
			    bounds: (({ west, south, east, north }) => [west, south, east, north])(props.tile.bbox),
			  }),
		});

		// ④3DTilesのレイヤーを準備
		const plateauLayer = new deck.Tile3DLayer({
		    data: '3dtiles/tileset.json',
		    loader: loaders.Tiles3DLoader,
		    // ⑧高さを引く
		    onTileLoad: (tileHeader) => {
		        tileHeader.content.cartographicOrigin.z = 
		          tileHeader.content.cartographicOrigin.z - (38 + 37);
		    },   
		});

		// ⑮（1）GeoJSONのレイヤーを作る部分を関数化
		function getGeoJsonLayer(searchid) {
			return new deck.GeoJsonLayer({
				data: 'geojson/Building.geojson',
				  getFilterValue: (f) => {
				  	console.log(f.id);
					return   (f.id == searchid) ? 0 : 1;
				  },
				  filterRange: [1, 1],
				  extensions: [new deck.DataFilterExtension({ filterSize: 1 })],
				  updateTriggers: {
				    getFilterValue: [searchid]
				  },
				// 塗り
				filled: true,
				getFillColor: [128, 0, 64, 64],
				// ⑮（2）searchidが更新時にgetFillColorが変わるようにする
//				updateTriggers: {
//					getFillColor: [searchid],
//					getLineColor: [searchid]	// ⑯（3）getLineColorも追加
//				},
				// 線
				stroked: true,
				getLineColor: [127, 127, 127],
				// 高さ押し出し機能をオン
				extruded: true,
				// 高さ（立ち上げ）の指定
				getElevation: f => {
					return f.properties.measuredHeight;
				},
				// GeoJSON中のZ座標は無視
				positionFormat: 'XY',
				// ⑩マウスオーバーで色を変える
				pickable: true,
				autoHighlight: true,
				highlightColor: [255, 255, 0, 128],
				// ⑬ポップアップする
				onHover: ({x, y, object}) => {
					const tooltip = document.getElementById('tooltip');
					if (object) {
						tooltip.innerHTML = 
							`<b>${object.properties.name}</b><br>高さ： ${object.properties.measuredHeight}m`;
						tooltip.style.left= `${x}px`;
						tooltip.style.top=`${y}px`;
						tooltip.style.display='block';
					} else {
						tooltip.style.display='none';
					}
				}
			});
		}
		// ⑨GeoJSONで表示する
		const geoJsonLayer = getGeoJsonLayer(null);
		
		// ⑤deck.glで表示する
		const deckgl = new deck.Deck({
			canvas: 'deck-canvas',	// 表示先
			layers: [
				tileLayer,	// 地理院地図
//				plateauLayer
				geoJsonLayer
			], // 表示レイヤー
			effects: [lightingEffect],	// LightingEffectの指定
			initialViewState: {	// 初期表示（視点）設定
				longitude: 139.691722, // 経度
				latitude: 35.689501,   // 緯度
				zoom: 15,        // ズーム
				minZoom: 2,     // 最小ズーム
				maxZoom: 18,     // 最大ズーム
				pitch: 45,      // 傾き
				bearing: 10,    // 回転
			},
			controller: true,
		});
		
		// ⑭（3）検索処理
		window.jump = (target) => {
			// 選択されたx、y、idを得る
			const selectedOption = 
				target.options[target.selectedIndex];
			const x = selectedOption.getAttribute('data-x');
			const y = selectedOption.getAttribute('data-y');
			const id = selectedOption.getAttribute('data-id');
			
			// ⑯（4）建物の3DTilesレイヤーを作る
			const targetLayer = new deck.Tile3DLayer({
			    data: `filtered_3dtiles/${id}/tileset.json`,
			    loader: loaders.Tiles3DLoader,
			    onTileLoad: (tileHeader) => {
			        tileHeader.content.cartographicOrigin.z = 
			          tileHeader.content.cartographicOrigin.z - (38 + 37);
			    },   
			});
			
			// 視点移動
			deckgl.setProps({
				initialViewState: {
					longitude: Number(x), // 経度
					latitude: Number(y),   // 緯度
					zoom: 15,        // ズーム
					pitch: 45,      // 傾き
					bearing: 10,    // 回転
					// アニメーションして移動
					transitionDuration: 1000,
					transitionInterpolator: new deck.FlyToInterpolator(),
				},
				// ⑮（2）色処理変更したレイヤーを再設定
				layers: [
					tileLayer,
					getGeoJsonLayer(id),
					targetLayer
				]
			});
		};
		
		// ⑰（3）カメラを動かす
		function routeStart(c) {
			let index = 0;
			
			function moveCamera() {
				if (index < c.length - 1) {
					// 始点と終点
					const [startLon, startLat] = c[index];
					const [endLon, endLat] = c[index + 1];
					// 始点から終点への方向
					const bearing = Math.atan2(endLon - startLon, endLat - startLat) * 180 / Math.PI;
					
					// そこに始点を移動する
					deckgl.setProps({
						viewState: {
							longitude: startLon,
							latitude: startLat,
							bearing : bearing,
							pitch: 10,
							position: [0, 0, 20],
							transitionDuration: 1000, // アニメーション時間
							transitionInterpolator:
								new deck.LinearInterpolator({transitionProps: ['longitude', 'latitude', 'bearing']})
						}
					});
					index++;
					setTimeout(moveCamera, 1000);
				}
			}
			moveCamera();
		}
		
		// ⑰（2）道案内経路の読み込みとFirstPersonViewの開始
		window.route = () => {
			// GeoJSONを読み込む
			fetch('route.geojson')
				.then(response => response.json())
				.then(data => {
					// 1本目のパスを取得
					const coordinates = data.features[0].geometry.coordinates;
					
					// FirstPersonViewに切り替え
					deckgl.setProps({
						views: new deck.FirstPersonView(),
						controller: {type: deck.FirstPersonController},
					});
					// 道案内開始
					routeStart(coordinates);
				});
		};
	</script>
	<!-- ⑫ツールチップのスタイル -->
	<style>
	#tooltip {
		position: absolute;
		background-color: rgba(0, 0, 0, 0.8);
		color: white;
		padding: 5px;
		border-radius: 5px;
		font-size: 12px;
		width: 200px;
		height: 48px;
		display: none;
		z-index: 1000;
	}  	
	</style>
</head>
<body>
	<!-- ②地図の描画領域 -->
	<div id="container">
		<canvas id="deck-canvas"></canvas>
		<!-- ⑪ツールチップを表示する場所 -->
		<div id="tooltip"></div>
	</div>
	<!-- ⑭（2）選択肢 -->
	<select id="search">
	    <option name="東京都庁第一本庁舎" data-x="139.691724" data-y="35.6894884"
	    	data-id="bldg_ffc04e24-60a0-48ce-8b20-93a51c160bb3">東京都庁第一本庁舎</option>
	    <option name="東京都庁第二本庁舎" data-x="139.6920962" data-y="35.6880005"
	    	data-id="bldg_68155acb-5edf-4ac3-b21c-a27306cfa8f5">東京都庁第二本庁舎</option>
	    <option name="新宿ワシントンホテル" data-x="139.6931292" data-y="35.6868335"
	    	data-id="bldg_841d1294-22c9-4395-99c3-c805a9a901e9">新宿ワシントンホテル</option>
	    <option name="パークハイアット東京" data-x="139.690879" data-y="35.6854741"
	    	data-id="bldg_6f8b966e-b948-4efc-a7ef-02890bea3457">パークハイアット東京</option>
	    <option name="文化学園服飾博物館" data-x="139.6950409" data-y="35.6862532"
	    	data-id="bldg_efc1ebe0-ba1b-42de-87b8-deadb5b20a22">文化学園服飾博物館</option>
	    <option name="JR東京総合病院" data-x="139.6999638" data-y="35.68556"
	    	data-id="bldg_2ad3209c-3b58-4e8c-933e-b54c5191aa33">JR東京総合病院</option>
	    <option name="新宿マインズタワー" data-x="139.6983935" data-y="35.6868644"
	    	data-id="bldg_cc2488b7-1e1f-47fb-bc9a-9880c2e9f4a2">新宿マインズタワー</option>
	    <option name="京王プラザホテル" data-x="139.6943153" data-y="35.6901424"
	    	data-id="bldg_594c17e3-cedb-4d35-abaf-8f79004e6c9f">京王プラザホテル</option>
	</select>
	<input type="submit" value="検索" onclick="jump(document.getElementById('search'));">
	<br>
	<!-- ⑰道案内のボタン -->
	<input type="button" value="道案内" onclick="route();">
</body>
</html>
